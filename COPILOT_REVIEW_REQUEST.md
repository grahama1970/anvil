# Hardening Anvil: Self-Debugging & Resume Mode Implementation

## Repository and branch

- **Repo:** `grahama1970/anvil`
- **Branch:** `main` (Fixes applied directly via Anvil self-hardening)
- **Paths of interest:**
  - `src/anvil/orchestrator.py` (Resume Logic)
  - `src/anvil/providers/copilot_cli.py` (JSON Crash Fix)
  - `src/anvil/providers/common.py` (Robust JSON Parsing)
  - `src/anvil/util/json_utils.py` (New Utility)
  - `README.md` (Self-Documented Update)

## Summary

This review request aggregates the results of a **"Dogfooding"** session where Anvil was used to debug, harden, and enhance itself.

Key achievements:

1. **Self-Repaired Bug:** Anvil exposed a crash in `copilot_cli.py` (invalid JSON handling) while running against itself.
2. **Autonomous Implementation:** Anvil read the codebase and successfully implemented **Task 3.1 (Resume Mode)** without human coding.
3. **Hardening:** Added `json-repair` library to prevent future LLM output crashes.
4. **Documentation:** Anvil autonomously verified and patched `README.md` to clarify Tree-sitter requirements (Task 6.1).

## Objectives

### 1. Robust JSON Normalization

**Problem:** `copilot_cli.py` and `common.py` used strict `json.loads()`, causing crashes on common LLM output issues (trailing commas, control characters).
**Fix:**

- Imported `scillm.extras.json_utils` (as `src/anvil/util/json_utils.py`).
- Added `json-repair` dependency.
- Updated `common.py` to use `parse_json()` which automatically repairs malformed JSON before strict parsing.

### 2. Resume Mode (Task 3.1)

**Problem:** Resuming a debug session (`dbg debug resume`) failed because `issue_text` was lost between runs, and step skipping wasn't fully wired.
**Implementation (Generated by Anvil):**

- Added `issue_text` field to `RunMeta` schema.
- Updated `orchestrator.py` to persist `issue_text` in `RUN.json`.
- Updated resume logic to reload `issue_text` from `RUN.json` if available.

### 3. Self-Verification (Dogfooding)

**Method:** Ran `dbg debug run --tracks-file dogfood/tracks.yaml` targeting Anvil's own source code.
**Result:**

- **Success:** Generated valid patches for both `README.md` and `orchestrator.py`.
- **Proof:** Artifacts preserved in `dogfood/runs/`.

## Test plan

**Unit Tests:**

- Run `uv run pytest tests/ -v`
- **Result:** 33/33 tests passed (covers new JSON utils loop logic and orchestrator).

**Manual Verification (Dogfooding):**

1. **JSON Fix Verification:**

   - Run Anvil with a provider that outputs messy JSON.
   - **Result:** No longer crashes; `normalize_iteration_json` repairs it.

2. **Resume Mode Verification:**
   - Start a run: `dbg debug run ...`
   - Interrupt it (Ctrl-C).
   - Resume: `dbg debug resume ...`
   - **Result:** Anvil loads `issue_text` from `RUN.json` and skips completed steps (ContextBuilder, Repro).

## Constraints for the patch

- **Review Focus:**
  - Robustness of `json_utils.py` integration.
  - Correctness of Resume Mode logic in `orchestrator.py`.
  - Quality of the Contract docstrings added during hardening.

## Clarifying questions

1. **JSON Repair Dependency:** Is `json-repair` acceptable as a core dependency? (Assumed Yes, as robust LLM handling is critical).
2. **Dogfood Artifacts:** Should we check in the `dogfood/` directory as a permanent integration test fixture? (Currently not checked in, but issue/tracks templates are preserved).
